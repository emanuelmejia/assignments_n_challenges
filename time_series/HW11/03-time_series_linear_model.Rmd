# (10 points) Time Series Linear Model and Cointegration

Daily electricity demand and temperature (in degrees Celsius) is recorded in `./data/temperature_demand.csv`. Please work through the following questions to build a time series linear model against this data.

```{r load packages for time series linear model,  results='hide', message=FALSE, warning=FALSE, echo=FALSE}
library(tidyverse)
library(feasts)
library(magrittr)
library(patchwork)
library(tsibble)
library(forecast)
library(lmtest)
library(lubridate)
library(fable)
library(tseries)
library(reshape)
```

```{r load temperature data, message=FALSE}
# Loading Data
temperature <- read_csv('./data/temperature_demand.csv') %>% 
  rename(
    c(
     'index' = '...1',
     'demand' = 'Demand', 
     'work_day'= 'WorkDay',
     'temperature' = 'Temperature'
    )
  )
# glimpse(temperature)

# Creating tsibble
temp.ts <- temperature %>%
  mutate(time_index = ...1) %>% 
  as_tsibble(index = time_index)
```

## Plot electricity

Plot electricity demand and temperature as time series. Is there any correlation between these to variables? If yes, Do you think is it a spurious correlation?

```{r plot electricity and temperature, fig.width=20, fig.height=7}
# Electricity Demand TS Plot
elec.plot <- ggplot(
    temp.ts, 
    aes(
      x = time_index, 
      y = Demand
      )
    ) +
    geom_line(
      size = 0.8,
      color = "cornflowerblue"
      ) +
    labs(
      title = "Electricity Demand",
      subtitle = "Daily Series",
      x = "Day",
      y = "Electricity Demand"
      ) +
      theme_classic() +
      theme(
      plot.title = element_text(color = "#0099F8",
                                size = 40,
                                face = "bold"),
      plot.subtitle = element_text(color="#969696",
                                size = 32,
                                face = "italic"),
      axis.title = element_text(color = "#969696",
                                size = 28,
                                face = "bold"),
      axis.text = element_text(color = "#969696", size = 28),
      axis.line = element_line(color = "#969696"),
      axis.ticks = element_line(color = "#969696"),
      )

# Temperature TS Plot
temp.plot <- ggplot(
    temp.ts, 
    aes(
      x = time_index, 
      y = Temperature
      )
    ) +
    geom_line(
      size = 0.8,
      color = "coral"
      ) +
    labs(
      title = "Temperature",
      subtitle = "Daily Series",
      x = "Day",
      y = "Temperature"
      ) +
      theme_classic() +
      theme(
      plot.title = element_text(color = "coral",
                                size = 40,
                                face = "bold"),
      plot.subtitle = element_text(color="#969696",
                                size = 32,
                                face = "italic"),
      axis.title = element_text(color = "#969696",
                                size = 28,
                                face = "bold"),
      axis.text = element_text(color = "#969696", size = 28),
      axis.line = element_line(color = "#969696"),
      axis.ticks = element_line(color = "#969696"),
      )

elec.plot | temp.plot
```

> There seems to be certain correlation. This could arise indeed a spurious regression since these variables may not be necessarily dependant on each other (for instance they both could be related to time of the day instead of being directly related). Although, since our measurement unit is "day" it could be that indeed we have at least a cointegration relationship or even a dependant variable on each other.

## Cointegration test

Use the Engle-Granger test to check for cointegration. What do you conclude? 

> In order to perform this cointegration test we will carry an ADF test first to determine whether both series are integrated in the same order.

```{r Augmented Dickey Fuller Tests, warning = FALSE}
adf.test(temp.ts$Demand, alternative = "stationary", k = 30)
adf.test(temp.ts$Temperature, alternative = "stationary", k = 30)

adf.test(diff(temp.ts$Demand), alternative = "stationary", k = 30)
adf.test(diff(temp.ts$Temperature), alternative = "stationary", k = 30)
```
> For the original series both p-values are much higher than 5% so we fail to reject the null hypothesis of a non stationary series (meaning we could have an unit root), but for their differences p-values are less than 5% so we reject the null hypothesis and we can proceed with the test since both are I(1).

```{r Cointegration test}
coint_reg <- lm(data = temp.ts, formula = Demand ~ Temperature)
coef(summary(coint_reg))
coint_res <- ts(coint_reg$res)
pp.test(coint_res)
``` 
> To perform the Engle-Granger we first run a regression of Electricity Demand on Temperature and then carry out a unit root test on the residuals.
Based on the Phillips-Perron Unit Root Test, the p-value is less than 5%, and we reject the null hypothesis of unit root for the residuals, so the test provides evidence that the Electricity Demand and Temperature are cointegrated since the residuals are stationary.


## Fit Model

Based on cointegration test, fit a regression model for demand with temperature as an explanatory variable(or their first difference).

> Since they're cointegrated we can perform a regression of Demand on Temperature. An also becauseboth of them are I(1) it makes sense to use their first difference as follows:

```{r Fit model}
# Creating a differences df
diff.df <- data.frame(
  Elec.diff = diff(temp.ts$Demand), 
  Temp.diff = diff(temp.ts$Temperature)
  )

# Regression on differenced series
elec.model <- lm(data = diff.df, formula = Elec.diff ~ Temp.diff)
summary(elec.model)
``` 
> Which gives us a positive and significant coefficient for temperature difference as an explanatory variable for the electricity demand difference.

## Residuals Plot

Produce a residual plot of the estimated model in previous part. Is the model adequate? Describe any outliers or influential observations, and discuss how the model could be improved.

```{r plot residuals}
# Plotting Residuals
elec.resid.plot <- elec.model %>%
  augment() %>%
  dplyr::select(.resid) %>%
  as.ts() %>% 
  autoplot(colour = "#0099F8") + labs(
    x = "Day",
    y = "Residuals",
    title = "Electric Demand on Temperature",
    subtitle = "Linear Regression Residuals"
  ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 20,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 14,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 12,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 11),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  )
elec.resid.plot
```

> This model seems adequate since residuals appear stationary although we still have certain outliers at the beginning of the year. In order to improve the model we could add an autoregressive component on top of this regression result, or add other variables to the model that could explain these outliers.

## Forecasting model

Use a model to forecast the electricity demand (with **prediction** intervals) that you would expect for the next day if the maximum temperature was $15^\circ$. Compare this with the forecast if the with maximum temperature was $35^\circ$. Do you believe these forecasts? Why or why not? 
 
```{r produce a forecast with the model}
# Last values
last.temp <- tail(temp.ts, 1)$Temperature
last.elec <- tail(temp.ts, 1)$Demand

# New assigned temperature differences
new.temp = data.frame(Temp.diff = c(15 - last.temp, 35 - last.temp))

# Predictions
diff.pred <- predict(elec.model, newdata = new.temp)
elec.pred <- diff.pred + last.elec

# Confidence intervals
conf.diff <- confint(object = elec.model, level = 0.95)
conf.15 <- last.elec + 
  c((15 - last.temp)*conf.diff[2], (15 - last.temp)*conf.diff[4])
conf.35 <- last.elec +
  c((35 - last.temp)*conf.diff[2], (35 - last.temp)*conf.diff[4])
```

> Since we're using first differences we will need the last known values for Temperature (`r last.temp`$^\circ$) and for demand (`r round(last.elec,2)`).
> So, for the case where maximum temperature is $15^\circ$, the difference would be `r 15 - last.temp`$^\circ$ and the predicted difference in electricity demand is `r round(diff.pred[1],2)`, so the electricity demand point estimate would be `r round(elec.pred[1],2)`, with a 95% confidence interval of (`r round(min(conf.15),2)`, `r round(max(conf.15),2)`).

> And for the case where maximum temperature is $35^\circ$, the difference would be `r 35 - last.temp`$^\circ$ and the predicted difference in electricity demand predicted is `r round(diff.pred[2],2)`, so the electricity demand point estimate would be `r round(elec.pred[2],2)`, with a 95% confidence interval of (`r round(min(conf.35),2)`, `r round(max(conf.35),2)`).
> Because all the process we've followed, and the results we've obtained of cointegration and residual analysis these seem like good forecasts.


