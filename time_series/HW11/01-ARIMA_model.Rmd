# (10 points) ARIMA model

Consider `fma::sheep`, the sheep population of England and Wales from 1867--1939. :sheep: 

```{r load libraries 1, results='hide', message=FALSE, warning=FALSE, echo=FALSE}
library(fma)
library(tidyverse)
library(feasts)
library(magrittr)
library(patchwork)
library(tsibble)
library(forecast)
library(lmtest)
library(lubridate)
library(fable)
library(tseries)
library(reshape)
```


```{r load sheep data, message=FALSE, warning=FALSE}
head(fma::sheep)
```

## Time series plot
Produce a time plot of the time series, and comment on what you observe. 

```{r produce a time series plot of sheep}
# Sheep TS plot
sheep_plot <- autoplot(
  fma::sheep,
  colour="cornflowerblue",
  size = 1
  ) +
  labs(
    title = "Sheep Population",
    subtitle = "of England and Wales",
    x = "Date",
    y = "Sheep Population (millions)"
       ) +
    theme_classic() +
    theme(
    plot.title = element_text(color = "#0099F8",
                              size = 20,
                              face = "bold"),
    plot.subtitle = element_text(color="#969696",
                                 size = 14,
                                 face = "italic"),
    axis.title = element_text(color = "#969696",
                              size = 12,
                              face = "bold"),
    axis.text = element_text(color = "#969696", size = 11),
    axis.line = element_line(color = "#969696"),
    axis.ticks = element_line(color = "#969696"),
    )
sheep_plot
```

> We can observe there's a negative trend (sheep population decreased as time passed), we have a couple of peaks which might mean certain seasonality or perhaps specific events that ocurred during those years.

## Fit a model 

Assume you decide to fit the following model: 

$$
  y_{t} = y_{t-1} + \phi_1(y_{t-1}-y_{t-2}) + \phi_2(y_{t-2}-y_{t-3}) + \phi_3(y_{t-3}-y_{t-4}) + \epsilon_t,
$$ 

where $\epsilon_t$ is a white noise series.

### Model type
What sort of ARIMA model is this (i.e., what are $p$, $d$, and $q$)?

> We're looking at an ARIMA(3,1,0) model. Meaning $p = 3$, $d = 1$, and $q = 0$.

### Back to the future 

Express this ARIMA model using backshift operator notation.

> We have the following model:
\begin{align*}
    y_{t} &= y_{t-1} + \phi_1(y_{t-1}-y_{t-2}) + \phi_2(y_{t-2}-y_{t-3}) + \phi_3(y_{t-3}-y_{t-4}) + \epsilon_t \\
    \\
    \iff \epsilon_t &= y_{t} - y_{t-1} - \phi_1(y_{t-1}-y_{t-2}) - \phi_2(y_{t-2}-y_{t-3}) - \phi_3(y_{t-3}-y_{t-4})\\
    &= (1-\mathbb{B}) y_{t} - \phi_1 (1-\mathbb{B}) y_{t-1} - \phi_2 (1-\mathbb{B}) y_{t-2} - \phi_3 (1-\mathbb{B}) y_{t-3}\\
    &= (1-\mathbb{B}) (y_{t} - \phi_1 y_{t-1} - \phi_2 y_{t-2} - \phi_3 y_{t-3}\\
    &= (1-\mathbb{B}) (1- \phi_1 \mathbb{B} - \phi_2 \mathbb{B}^2 - \phi_3 \mathbb{B}^3) y_{t}\\
\end{align*}

> And so we have a model $\theta_3(\mathbb{B})(1-\mathbb{B})^1 y_{t} = \epsilon_t$ which is consistent with the $p$, $d$, and $q$ previously stated.

## Is this model appropriate? 

Examine the ACF and PACF of the differenced data. Evaluate whether this model is appropriate. 

```{r ACF PACF plots}
# Getting a tsibble with index from the original ts
sheep.ts <- data.frame(
  date = index(fma::sheep), 
  sheep = melt(fma::sheep)$value
  )

sheep.ts <- sheep.ts %>%
  mutate(time_index = year(make_datetime(date))) %>% 
  as_tsibble(index = time_index)

# ACF plot - Original Series
sheep.acf <- ACF(
sheep.ts,
sheep
) %>% autoplot() +
  labs(
      title = "Autocorrelation Function",
      subtitle = "Sheep Series",
      x = "lag [Unit = 1Y]",
      y = "Autocorrelation"
    ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 12,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 9,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 8,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 8),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  )

# PACF plot - Original Series
sheep.pacf <- PACF(
sheep.ts,
sheep
) %>% autoplot() +
  labs(
      title = "Partial Autocorrelation Function",
      subtitle = "Sheep Series",
      x = "lag [Unit = 1Y]",
      y = "Partial Autocorrelation"
    ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 12,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 9,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 8,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 8),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  )

# ACF plot - Differenced Series
diff.acf <- ACF(
sheep.ts,
diff(sheep)
) %>% autoplot() +
  labs(
      title = "Autocorrelation Function",
      subtitle = "Sheep Differenced Series",
      x = "lag [Unit = 1Y]",
      y = "Autocorrelation"
    ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 12,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 9,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 8,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 8),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  )

# PACF plot - Differenced Series
diff.pacf <- PACF(
sheep.ts,
diff(sheep)
) %>% autoplot() +
  labs(
      title = "Partial Autocorrelation Function",
      subtitle = "Sheep Differenced Series",
      x = "lag [Unit = 1Y]",
      y = "Partial Autocorrelation"
    ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 12,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 9,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 8,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 8),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  )

# 2x2 grid to compare original VS differenced
(sheep.acf | diff.acf) /(sheep.pacf | diff.pacf)
```

> By looking at the original series' graphs (left) and comparing them to the differenced series (right) we can see that differencing the series removed the trend as expected and stabilized the PACF values, so it seems like there's indeed an unit root and this might be a good step to take, although we still don't have a stationary process quite yet, perhaps due to an AR process as well as a seasonal component which would explain the fluctuations.

## Forecasts, by hand! 
The last five values of the series are given below:

| Year              | 1935 | 1936 | 1937 | 1938 | 1939 |
|:------------------|-----:|-----:|-----:|-----:|-----:|
| Millions of sheep | 1648 | 1665 | 1627 | 1791 | 1797 |

The estimated parameters are: 

- $\phi_1 =  0.42$; 
- $\phi_2 = -0.20$;  and, 
- $\phi_3 = -0.30$.

Without using the forecast function, calculate forecasts for the next three years (1940--1942).

```{r create forcasts by hand}
## Using R as a calculator here
y_35 <- 1648
y_36 <- 1665
y_37 <- 1627
y_38 <- 1791
y_39 <- 1797

y_40 <- y_39 + 
  0.42 * (y_39-y_38) - 
  0.20 * (y_38-y_37) - 
  0.30 * (y_37-y_36)

y_41 <- y_40 + 
  0.42 * (y_40-y_39) - 
  0.20 * (y_39-y_38) - 
  0.30 * (y_38-y_37)

y_42 <- y_41 + 
  0.42 * (y_41-y_40) - 
  0.20 * (y_40-y_39) - 
  0.30 * (y_39-y_38)
```

We have:

$\hat{y}_{1940} = y_{1939} + \phi_1(y_{1939}-y_{1938}) + \phi_2(y_{1938}-y_{1937}) + \phi_3(y_{1937}-y_{1936}) =$ `r round(y_40,2)`

$\hat{y}_{1941} = y_{1940} + \phi_1(y_{1940}-y_{1939}) + \phi_2(y_{1939}-y_{1938}) + \phi_3(y_{1938}-y_{1937}) =$ `r round(y_41,2)`

$\hat{y}_{1942} = y_{1941} + \phi_1(y_{1941}-y_{1940}) + \phi_2(y_{1940}-y_{1939}) + \phi_3(y_{1939}-y_{1938}) =$ `r round(y_42,2)`

## Interpret roots
Find the roots of your model's characteristic equation. Is this process stationary?.

```{r roots}
roots <- polyroot(c(1, -0.42, 0.20, 0.30))
roots
```

> Since we have $d = 1$ we would say that the process is non-stationary to begin with, but applying this first difference, we have that the characteristic equation is $(1- \phi_1 \mathbb{B} - \phi_2 \mathbb{B}^2 - \phi_3 \mathbb{B}^3)$.

> The roots will be:

- $\mathbb{B}_1 =$ `r round(roots[1],2)`
- $\mathbb{B}_2 =$ `r round(roots[2],2)`
- $\mathbb{B}_3 =$ `r round(roots[3],2)`

> And their absolute value would be:

- $|\mathbb{B}_1| =$ `r round(Mod(roots[1]),3)`
- $|\mathbb{B}_2| =$ `r round(Mod(roots[2]),3)`
- $|\mathbb{B}_3| =$ `r round(Mod(roots[3]),3)`

> Since all of them, in absolute value, exceed the unity we would say the process is stationary.